\section{Implicit model following}
\label{sec:implicit_model_following}
\index{controller design!linear-quadratic regulator!implicit model following}

If we want to design a feedback controller that erases the dynamics of our
system and makes it behave like some other system, we can use \textit{implicit
model following}. This is used on the Blackhawk helicopter at NASA Ames research
center when they want to make it fly like experimental aircraft (within the
limits of the helicopter's actuators, of course).

Let the original system dynamics be
\begin{align*}
  \dot{\mat{x}} &= \mat{A}\mat{x} + \mat{B}\mat{u} \\
  \mat{y} &= \mat{C}\mat{x}
\end{align*}

and the desired system dynamics be
\begin{equation*}
  \dot{\mat{z}} = \mat{A}_{ref}\mat{z}
\end{equation*}
\begin{align*}
  \dot{\mat{y}} &= \mat{C}\dot{\mat{x}} \\
  \dot{\mat{y}} &= \mat{C}(\mat{A}\mat{x} + \mat{B}\mat{u}) \\
  \dot{\mat{y}} &= \mat{C}\mat{A}\mat{x} + \mat{C}\mat{B}\mat{u}
\end{align*}

We want to minimize the following cost functional.
\begin{equation*}
  J = \int_0^\infty \left((\dot{\mat{y}} - \dot{\mat{z}})^T \mat{Q} (\dot{\mat{y}} - \dot{\mat{z}}) + \mat{u}^T\mat{R}\mat{u}\right) dt
\end{equation*}

We'll be measuring the desired system's state, so let $\mat{y} = \mat{z}$.
\begin{align*}
  \dot{\mat{z}} &= \mat{A}_{ref}\mat{y} \\
  \dot{\mat{z}} &= \mat{A}_{ref}\mat{C}\mat{x}
\end{align*}

Therefore,
\begin{align*}
  \dot{\mat{y}} - \dot{\mat{z}} &=
    \mat{C}\mat{A}\mat{x} + \mat{C}\mat{B}\mat{u} -
    (\mat{A}_{ref}\mat{C}\mat{x}) \\
  \dot{\mat{y}} - \dot{\mat{z}} &=
    (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})\mat{x} + \mat{C}\mat{B}\mat{u}
\end{align*}

Substitute this into the cost functional.
\begin{align*}
  J &= \int_0^\infty \left((\dot{\mat{y}} - \dot{\mat{z}})^T \mat{Q} (\dot{\mat{y}} - \dot{\mat{z}}) + \mat{u}^T\mat{R}\mat{u}\right) dt \\
  J &= \int_0^\infty \left(
    ((\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})\mat{x} + \mat{C}\mat{B}\mat{u})^T
    \mat{Q}
    ((\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})\mat{x} + \mat{C}\mat{B}\mat{u}) +
    \mat{u}^T\mat{R}\mat{u}\right) dt
\end{align*}

Apply the transpose to the left-hand side of the $\mat{Q}$ term.
\begin{equation*}
  J = \int_0^\infty \left(
    (\mat{x}^T(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T + \mat{u}^T(\mat{C}\mat{B})^T)
    \mat{Q}
    ((\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})\mat{x} + \mat{C}\mat{B}\mat{u}) +
    \mat{u}^T\mat{R}\mat{u}\right) dt
\end{equation*}

Factor out $\begin{bmatrix}\mat{x} \\ \mat{u}\end{bmatrix}^T$ from the left side
and $\begin{bmatrix}\mat{x} \\ \mat{u}\end{bmatrix}$ from the right side of each
term.
\begin{align*}
  J &= \int_0^\infty \left(
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}^T
    \begin{bmatrix}
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T \\
      (\mat{C}\mat{B})^T
    \end{bmatrix}
    \mat{Q}
    \begin{bmatrix}
      \mat{C}\mat{A} - \mat{A}_{ref}\mat{C} &
      \mat{C}\mat{B}
    \end{bmatrix}
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix} +
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}^T
    \begin{bmatrix}
      \mat{0} & \mat{0} \\
      \mat{0} & \mat{R}
    \end{bmatrix}
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}
    \right) dt \\
  J &= \int_0^\infty \left(
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}^T
    \left(
    \begin{bmatrix}
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T \\
      (\mat{C}\mat{B})^T
    \end{bmatrix}
    \mat{Q}
    \begin{bmatrix}
      \mat{C}\mat{A} - \mat{A}_{ref}\mat{C} &
      \mat{C}\mat{B}
    \end{bmatrix} +
    \begin{bmatrix}
      \mat{0} & \mat{0} \\
      \mat{0} & \mat{R}
    \end{bmatrix}
    \right)
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}
    \right) dt
\end{align*}

Multiply in $\mat{Q}$.
\begin{equation*}
  J = \int_0^\infty \left(
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}^T
    \left(
    \begin{bmatrix}
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q} \\
      (\mat{C}\mat{B})^T\mat{Q}
    \end{bmatrix}
    \begin{bmatrix}
      \mat{C}\mat{A} - \mat{A}_{ref}\mat{C} &
      \mat{C}\mat{B}
    \end{bmatrix} +
    \begin{bmatrix}
      \mat{0} & \mat{0} \\
      \mat{0} & \mat{R}
    \end{bmatrix}
    \right)
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}
    \right) dt
\end{equation*}

Multiply matrices in the left term together.
\begin{equation*}
  J = \int_0^\infty \left(
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}^T
    \left(
    \begin{bmatrix}
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q}(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C}) &
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q}(\mat{C}\mat{B}) \\
      (\mat{C}\mat{B})^T\mat{Q}(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C}) &
      (\mat{C}\mat{B})^T\mat{Q}(\mat{C}\mat{B})
    \end{bmatrix} +
    \begin{bmatrix}
      \mat{0} & \mat{0} \\
      \mat{0} & \mat{R}
    \end{bmatrix}
    \right)
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}
    \right) dt
\end{equation*}

Add the terms together.
\begin{equation}
  J = \int_0^\infty
  \begin{bmatrix}
    \mat{x} \\
    \mat{u}
  \end{bmatrix}^T
  \begin{bmatrix}
    \underbrace{(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q}
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})}_{\mat{Q}} &
    \underbrace{(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q}
      (\mat{C}\mat{B})}_{\mat{N}} \\
    \underbrace{(\mat{C}\mat{B})^T\mat{Q}
      (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})}_{\mat{N}^T} &
    \underbrace{(\mat{C}\mat{B})^T\mat{Q}(\mat{C}\mat{B}) + \mat{R}}_{\mat{R}}
  \end{bmatrix}
  \begin{bmatrix}
    \mat{x} \\
    \mat{u}
  \end{bmatrix}
  dt
\end{equation}

Thus, implicit model following can be defined as the following optimization
problem.
\begin{theorem}[Implicit model following]
  \begin{align}
    \min_{\mat{u}} &\int_0^\infty
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}^T
    \begin{bmatrix}
      \underbrace{(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q}
        (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})}_{\mat{Q}} &
      \underbrace{(\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})^T\mat{Q}
        (\mat{C}\mat{B})}_{\mat{N}} \\
      \underbrace{(\mat{C}\mat{B})^T\mat{Q}
        (\mat{C}\mat{A} - \mat{A}_{ref}\mat{C})}_{\mat{N}^T} &
      \underbrace{(\mat{C}\mat{B})^T\mat{Q}(\mat{C}\mat{B}) + \mat{R}}_{\mat{R}}
    \end{bmatrix}
    \begin{bmatrix}
      \mat{x} \\
      \mat{u}
    \end{bmatrix}
    dt \nonumber \\
    \text{subject to } &\dot{\mat{x}} = \mat{A}\mat{x} + \mat{B}\mat{u}
  \end{align}

  The optimal control policy $\mat{u}^*$ is $-\mat{K}\mat{x}$. $\mat{K}$ can be
  computed via the typical LQR equations based on the algebraic Ricatti
  equation.
\end{theorem}

The control law $\mat{u}_{imf} = -\mat{K}\mat{x}$ makes
$\dot{\mat{x}} = \mat{A}\mat{x} + \mat{B}\mat{u}_{imf}$ match the open-loop
response of $\dot{\mat{z}} = \mat{A}_{ref}\mat{z}$.

If the original and desired system have the same states, then
$\mat{C} = \mat{I}$ and the cost functional simplifies to
\begin{equation}
  J = \int_0^\infty
  \begin{bmatrix}
    \mat{x} \\
    \mat{u}
  \end{bmatrix}^T
  \begin{bmatrix}
    \underbrace{(\mat{A} - \mat{A}_{ref})^T\mat{Q}
      (\mat{A} - \mat{A}_{ref})}_{\mat{Q}} &
    \underbrace{(\mat{A} - \mat{A}_{ref})^T\mat{Q}\mat{B}}_{\mat{N}} \\
    \underbrace{\mat{B}^T\mat{Q}(\mat{A} - \mat{A}_{ref})}_{\mat{N}^T} &
    \underbrace{\mat{B}^T\mat{Q}\mat{B} + \mat{R}}_{\mat{R}}
  \end{bmatrix}
  \begin{bmatrix}
    \mat{x} \\
    \mat{u}
  \end{bmatrix}
  dt
\end{equation}
